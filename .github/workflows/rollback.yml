name: Automatic Rollback

on:
  workflow_dispatch:

jobs:
  rollback:
    runs-on: ubuntu-latest
    env:
      RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
      RENDER_SERVICE_ID: srv-d4afj66r433s73ejdkg0

    steps:
      - name: Listar deploys en Render
        run: |
          echo "Obteniendo lista de deploys..."
          DEPLOYS=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" \
            "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys")

          echo "Deploys obtenidos:"
          echo "$DEPLOYS"

          LAST_SUCCESSFUL=$(echo $DEPLOYS | jq -r '.[] | select(.status=="live" or .status=="succeeded" or .status=="deployed") | .id' | head -n 1)

          if [ -z "$LAST_SUCCESSFUL" ]; then
              echo "No se encontró un deploy exitoso. Saltando rollback."
              exit 0
          fi

          echo "Último deploy válido encontrado: $LAST_SUCCESSFUL"
          
          echo "Ejecutando rollback..."
          curl -X POST \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys/$LAST_SUCCESSFUL/redeploy"

          echo "Rollback ejecutado correctamente."
